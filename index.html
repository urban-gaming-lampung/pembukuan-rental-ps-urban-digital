<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>URBAN Gaming Invoice Generator + AI</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- html2pdf.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* Custom Styles */
        body { font-family: 'Inter', sans-serif; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        @keyframes fade-in { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fade-in 0.4s ease-out forwards; }
        
        /* Loading Sparkle Animation */
        @keyframes sparkle {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
            100% { opacity: 1; transform: scale(1); }
        }
        .sparkle-anim { animation: sparkle 1.5s infinite; }

        /* PRINT STYLES - Hides everything except the invoice area */
        @media print {
            body * {
                visibility: hidden;
            }
            .printable-area, .printable-area * {
                visibility: visible;
            }
            .printable-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                margin: 0;
                padding: 0;
                background: white;
                box-shadow: none;
                border: none;
            }
            .no-print {
                display: none !important;
            }
        }
    </style>
</head>
<body class="bg-gray-50 text-slate-800">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect } = React;

        // --- KONFIGURASI API KEY ---
        // PENTING: Ganti string kosong di bawah ini dengan API Key Gemini Anda
        const apiKey = "AIzaSyBpWVjSVje-g76J-v2Z0CBJAZrDaODjhRg"; 

        // --- Helper: Panggil Gemini API ---
        const generateWithGemini = async (prompt) => {
            if (!apiKey) {
                alert("Fitur AI belum aktif. Mohon buka file 'index.html' ini dengan text editor (Notepad/VS Code), lalu isi bagian 'const apiKey' dengan API Key Gemini Anda.");
                return null;
            }

            try {
                const response = await fetch(
                    `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`,
                    {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: prompt }] }]
                        }),
                    }
                );

                if (!response.ok) throw new Error("Gagal menghubungi Gemini");
                const data = await response.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text || null;
            } catch (error) {
                console.error("Gemini Error:", error);
                alert("Maaf, terjadi kesalahan saat menghubungi AI. Periksa koneksi internet atau API Key Anda.");
                return null;
            }
        };

        // --- Ikon SVG Inline ---
        const IconGamepad = ({size=24}) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="6" y1="12" x2="10" y2="12"/><line x1="8" y1="10" x2="8" y2="14"/><line x1="15" y1="13" x2="15.01" y2="13"/><line x1="18" y1="11" x2="18.01" y2="11"/><rect x="2" y="6" width="20" height="12" rx="2"/></svg>);
        const IconPackage = ({size=24}) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16.5 9.4L7.5 4.21"/><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></svg>);
        const IconWrench = ({size=24}) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg>);
        const IconFileText = ({size=24}) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>);
        const IconPrinter = ({size=24}) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>);
        const IconX = ({size=24}) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>);
        const IconShare = ({size=24}) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></svg>);
        const IconDownload = ({size=24}) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>);
        const IconSparkles = ({size=24, className=""}) => (<svg className={className} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L12 3Z"/></svg>);
        
        // --- New Icons for UI Upgrade ---
        const IconUser = ({size=20}) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>);
        const IconClock = ({size=20}) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>);
        const IconMapPin = ({size=20}) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>);
        const IconTag = ({size=20}) => (<svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg>);

        // --- Main App Component ---
        const App = () => {
            const [activeTab, setActiveTab] = useState(0);

            const tabs = [
                { id: 0, label: 'Invoice SEWA PS', icon: <IconGamepad size={18} /> },
                { id: 1, label: 'Invoice Isi Game', icon: <IconPackage size={18} /> },
                { id: 2, label: 'Invoice Service', icon: <IconWrench size={18} /> },
            ];

            return (
                <div className="min-h-screen pb-12 bg-gray-50/50 no-print">
                    {/* Header */}
                    <header className="bg-white shadow-sm sticky top-0 z-20 backdrop-blur-md bg-white/90">
                        <div className="max-w-3xl mx-auto px-4 py-4 text-center">
                        <h1 className="text-xl md:text-2xl font-bold text-indigo-800 tracking-tight">
                            Input Invoice Otomatis
                        </h1>
                        <p className="text-xs font-bold text-indigo-500 uppercase tracking-widest mt-1">
                            URBAN Gaming Lampung
                        </p>
                        </div>
                    </header>

                    {/* Main Content */}
                    <main className="max-w-4xl mx-auto px-4 py-6">
                        {/* Navigation Tabs */}
                        <div className="flex bg-gray-200/80 p-1.5 rounded-xl mb-6 overflow-x-auto no-scrollbar gap-1">
                        {tabs.map((tab) => (
                            <button
                            key={tab.id}
                            onClick={() => setActiveTab(tab.id)}
                            className={`flex-1 flex items-center justify-center gap-2 py-2.5 px-4 rounded-lg text-sm font-semibold transition-all duration-200 whitespace-nowrap
                                ${activeTab === tab.id 
                                ? 'bg-white text-indigo-600 shadow-sm ring-1 ring-black/5 scale-[1.02]' 
                                : 'text-gray-500 hover:text-gray-700 hover:bg-gray-300/50'
                                }`}
                            >
                            {tab.icon}
                            {tab.label}
                            </button>
                        ))}
                        </div>

                        {/* Tab Content */}
                        <div className="bg-white rounded-2xl shadow-lg shadow-indigo-100/50 border border-gray-100 overflow-hidden min-h-[400px]">
                        {activeTab === 0 && <SewaPSForm />}
                        {activeTab === 1 && <IsiGameForm />}
                        {activeTab === 2 && <ServiceForm />}
                        </div>
                    </main>
                </div>
            );
        };

        // --- KOMPONEN: Invoice Preview Umum (Reusable) ---
        const InvoicePreview = ({ 
            title = "INVOICE", 
            customerName, 
            date, 
            items = [], 
            total, 
            terms, // Added prop for Terms & Conditions
            onClose, 
            onShareWA, 
            onDownloadPDF,
            isPdfProcessing,
            isMsgLoading,
            invoiceRef 
        }) => {
            return (
                <div className="animate-fade-in fixed inset-0 z-50 bg-white md:static md:bg-transparent overflow-y-auto">
                     {/* Actions Bar (Hidden on Print) */}
                    <div className="no-print flex gap-2 mb-6 justify-between items-center bg-gray-100 p-2 rounded-lg sticky top-0 z-50">
                        <button 
                            onClick={onClose}
                            className="p-2 text-gray-500 hover:bg-white hover:text-red-500 rounded-lg transition-colors"
                            title="Tutup / Edit Kembali"
                        >
                            <IconX size={20} />
                        </button>
                        <div className="flex gap-2">
                             <button 
                                onClick={() => window.print()}
                                className="px-3 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg text-sm font-medium flex items-center gap-2 shadow-md transition-all"
                                title="Print Browser"
                            >
                                <IconPrinter size={16} /> Print
                            </button>
                            {onShareWA && (
                                <button 
                                    onClick={onShareWA}
                                    disabled={isMsgLoading}
                                    className={`px-3 py-2 rounded-lg text-sm font-medium flex items-center gap-2 text-white transition-all hidden md:flex
                                        ${isMsgLoading ? 'bg-green-400 cursor-wait' : 'bg-green-600 hover:bg-green-700 shadow-md'}`}
                                >
                                    <IconSparkles size={16} className={isMsgLoading ? "animate-spin" : ""} /> 
                                    WA
                                </button>
                            )}
                            <button 
                                onClick={onDownloadPDF}
                                disabled={isPdfProcessing}
                                className={`px-3 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-medium flex items-center gap-2 shadow-md transition-all
                                    ${isPdfProcessing ? 'opacity-70 cursor-wait' : ''}`}
                            >
                                {isPdfProcessing ? <span className="animate-pulse">...</span> : <><IconShare size={16} /> PDF</>}
                            </button>
                        </div>
                    </div>

                    {/* INVOICE AREA (Printable) */}
                    <div className="printable-area border shadow-2xl rounded-sm overflow-hidden bg-white mx-auto max-w-[210mm] min-h-[297mm] md:min-h-0 md:h-auto" ref={invoiceRef}>
                        {/* Header */}
                        <div className="bg-indigo-900 text-white p-8 flex justify-between items-start">
                            <div>
                                <h2 className="text-3xl font-extrabold tracking-wide">{title}</h2>
                                <p className="text-indigo-200 text-sm mt-1">#{Date.now().toString().slice(-6)}</p>
                            </div>
                            <div className="text-right flex flex-col items-end">
                                <img 
                                    src="logo.png" 
                                    onError={(e) => { e.target.onerror = null; e.target.src = "https://i.ibb.co.com/207KDFc7/PLAYBOX.png"; }}
                                    alt="Logo" 
                                    className="h-16 mb-2 object-contain bg-white rounded-lg p-1"
                                />
                                <h3 className="font-bold text-lg">URBAN Gaming Lampung</h3>
                                <p className="text-indigo-200 text-xs mt-1">Rental PlayStation & Service</p>
                                <p className="text-indigo-200 text-xs">Lampung, Indonesia</p>
                            </div>
                        </div>

                        {/* Customer Info */}
                        <div className="p-8">
                            <div className="flex flex-col md:flex-row justify-between mb-8 text-sm">
                                <div className="mb-4 md:mb-0">
                                    <p className="text-gray-500 font-medium uppercase text-xs mb-1">Ditagihkan Kepada:</p>
                                    <p className="font-bold text-lg text-gray-800">{customerName || '-'}</p>
                                    <p className="text-gray-600">{date}</p>
                                </div>
                                <div className="text-right">
                                    <p className="text-gray-500 font-medium uppercase text-xs mb-1">Tanggal Cetak:</p>
                                    <p className="font-bold text-gray-800">{new Date().toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</p>
                                </div>
                            </div>

                            {/* Table Items */}
                            <div className="mt-8">
                                <table className="w-full text-left border-collapse">
                                    <thead>
                                        <tr>
                                            <th className="py-3 px-4 bg-gray-50 font-bold uppercase text-xs text-gray-500 border-b border-gray-200">Deskripsi</th>
                                            <th className="py-3 px-4 bg-gray-50 font-bold uppercase text-xs text-gray-500 border-b border-gray-200 text-right">Harga</th>
                                        </tr>
                                    </thead>
                                    <tbody className="text-sm">
                                        {items.map((item, idx) => (
                                            <tr key={idx}>
                                                <td className="py-4 px-4 border-b border-gray-100">
                                                    <p className="font-bold text-gray-800">{item.name}</p>
                                                    {item.desc && <p className="text-gray-500 text-xs mt-1 whitespace-pre-wrap">{item.desc}</p>}
                                                </td>
                                                <td className="py-4 px-4 border-b border-gray-100 text-right font-medium">
                                                    Rp {item.price.toLocaleString('id-ID')}
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                    <tfoot>
                                        <tr>
                                            <td className="py-4 px-4 text-right font-bold text-gray-600">Total Tagihan</td>
                                            <td className="py-4 px-4 text-right font-bold text-xl text-indigo-600">
                                                Rp {total.toLocaleString('id-ID')}
                                            </td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>

                            {/* Terms Section (Restored) */}
                            {terms && (
                                <div className="mt-12 bg-indigo-50 p-4 rounded-lg border border-indigo-100">
                                    <h4 className="font-bold text-indigo-800 text-sm mb-2 flex items-center gap-2">
                                        <IconFileText size={14}/> Syarat & Ketentuan
                                    </h4>
                                    <div className="text-xs text-indigo-700 leading-relaxed">
                                        {terms}
                                    </div>
                                </div>
                            )}

                            {/* Footer */}
                            <div className="mt-12 text-center">
                                <p className="text-xs text-gray-400">Terima kasih telah mempercayakan kebutuhan gaming Anda kepada URBAN Gaming Lampung ðŸŽ®</p>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- KOMPONEN 1: Sewa PS ---
        const SewaPSForm = () => {
            const [rawChat, setRawChat] = useState(`Sewa PS URBAN PlayStation 
Nama Penyewa : Andi Gaming
Jenis PS : PS5 + TV 4K
Lama Sewa : 24 Jam
Antar Jemput : Ya`);
            
            const [customerName, setCustomerName] = useState('');
            const [psType, setPsType] = useState('');
            const [duration, setDuration] = useState('');
            const [delivery, setDelivery] = useState('');
            const [price, setPrice] = useState('');
            const [shipping, setShipping] = useState('');
            
            const [showInvoice, setShowInvoice] = useState(false);
            const [isAiLoading, setIsAiLoading] = useState(false);
            const [isMsgLoading, setIsMsgLoading] = useState(false);
            const [isPdfProcessing, setIsPdfProcessing] = useState(false);
            
            const invoiceRef = useRef();

            useEffect(() => { manualParse(); }, []);
            const manualParse = () => {
                const lines = rawChat.split('\n');
                const findVal = (key) => lines.find(l => l.toLowerCase().includes(key.toLowerCase()))?.split(':')[1]?.trim() || '';
                if(!customerName) setCustomerName(findVal('Nama'));
                if(!psType) setPsType(findVal('Jenis'));
                if(!duration) setDuration(findVal('Lama'));
                if(!delivery) setDelivery(findVal('Antar'));
            };

            const handleAiExtract = async () => {
                setIsAiLoading(true);
                const prompt = `Kamu admin rental PS. Ekstrak JSON: { "nama": "", "jenis_ps": "", "lama": "", "antar_status": "", "harga_sewa": 0, "ongkir": 0 } dari: """${rawChat}""". Valid JSON only.`;
                const result = await generateWithGemini(prompt);
                if (result) {
                    try {
                        const cleaned = result.replace(/```json/g, '').replace(/```/g, '').trim();
                        const data = JSON.parse(cleaned);
                        setCustomerName(data.nama || customerName);
                        setPsType(data.jenis_ps || psType);
                        setDuration(data.lama || duration);
                        setDelivery(data.antar_status || delivery);
                        if(data.harga_sewa > 0) setPrice(data.harga_sewa.toString());
                        if(data.ongkir > 0) setShipping(data.ongkir.toString());
                    } catch (e) { alert("Gagal membaca respon AI."); }
                }
                setIsAiLoading(false);
            };

            const handleDownloadPDF = async () => {
                if (!window.html2pdf) { alert("Sistem PDF belum siap."); return; }
                setIsPdfProcessing(true);
                const element = invoiceRef.current;
                const filename = `Invoice_Sewa_${(customerName || 'Cust').replace(/\s+/g, '_')}_${Date.now()}.pdf`;
                const opt = { margin: 0, filename: filename, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2, useCORS: true }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' } };
                try {
                    const worker = window.html2pdf().set(opt).from(element);
                    const pdfBlob = await worker.output('blob');
                    const file = new File([pdfBlob], filename, { type: 'application/pdf' });
                    if (navigator.canShare && navigator.canShare({ files: [file] })) {
                        await navigator.share({ files: [file], title: 'Invoice URBAN Gaming', text: `Invoice Sewa PS untuk ${customerName}` });
                    } else {
                        window.html2pdf().set(opt).from(element).save();
                    }
                } catch (err) { window.html2pdf().set(opt).from(element).save(); } finally { setIsPdfProcessing(false); }
            };

            const handleShareWA = async () => {
                setIsMsgLoading(true);
                const total = (parseInt(price) || 0) + (parseInt(shipping) || 0);
                const prompt = `Buat caption WA invoice rental PS untuk ${customerName}, unit ${psType}, durasi ${duration}, total Rp ${total.toLocaleString('id-ID')}. Bahasa gaul sopan, emoji gaming.`;
                const aiMessage = await generateWithGemini(prompt);
                const finalMessage = aiMessage || `Halo ${customerName}! Invoice sewa ${psType} total Rp ${total.toLocaleString('id-ID')} sudah siap.`;
                setIsMsgLoading(false);
                window.open(`https://wa.me/?text=${encodeURIComponent(finalMessage)}`, '_blank');
            };

            const invoiceItems = [
                { name: "Sewa Unit Console", desc: `${psType || '-'} (${duration || '-'})`, price: parseInt(price) || 0 },
            ];
            if(parseInt(shipping) > 0) invoiceItems.push({ name: "Biaya Pengiriman", desc: "Ongkos Kirim / Antar Jemput", price: parseInt(shipping) || 0 });

            // Specific Terms for Sewa PS
            const sewaTerms = (
                <>
                    <p>1. Siapkan <strong>KTP + SIM/STNK</strong> asli untuk syarat jaminan.</p>
                    <p>2. Kerusakan unit selama masa sewa menjadi tanggung jawab penyewa.</p>
                    <p>3. Keterlambatan pengembalian akan dikenakan denda sesuai ketentuan.</p>
                </>
            );

            if(showInvoice) {
                return <InvoicePreview 
                    title="INVOICE SEWA"
                    customerName={customerName}
                    date={`Layanan: ${delivery}`}
                    items={invoiceItems}
                    total={(parseInt(price) || 0) + (parseInt(shipping) || 0)}
                    terms={sewaTerms}
                    onClose={() => setShowInvoice(false)}
                    onShareWA={handleShareWA}
                    onDownloadPDF={handleDownloadPDF}
                    isPdfProcessing={isPdfProcessing}
                    isMsgLoading={isMsgLoading}
                    invoiceRef={invoiceRef}
                />;
            }

            const currentTotal = (parseInt(price) || 0) + (parseInt(shipping) || 0);

            return (
                <div className="p-6 relative space-y-6 animate-fade-in">
                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        {/* LEFT COLUMN: SOURCE (CHAT) */}
                        <div className="lg:col-span-1 space-y-4">
                            <div className="bg-white p-5 rounded-2xl border border-gray-100 shadow-sm">
                                <label className="text-sm font-bold text-gray-700 flex items-center gap-2 mb-3">
                                    <IconFileText size={18} className="text-indigo-500" /> 
                                    Sumber Data (Chat)
                                </label>
                                <textarea 
                                    value={rawChat} 
                                    onChange={(e) => setRawChat(e.target.value)} 
                                    className="w-full p-3 text-sm border border-gray-200 rounded-xl h-64 font-mono resize-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all" 
                                    placeholder="Paste chat disini..." 
                                />
                                <button 
                                    onClick={handleAiExtract} 
                                    disabled={isAiLoading} 
                                    className={`w-full mt-3 py-2.5 rounded-xl font-bold text-sm flex items-center justify-center gap-2 transition-all shadow-md hover:shadow-lg
                                        ${isAiLoading ? 'bg-gray-100 text-gray-400' : 'bg-gradient-to-r from-indigo-600 to-purple-600 text-white hover:scale-[1.02]'}`}
                                >
                                    <IconSparkles size={16} className={isAiLoading ? "sparkle-anim" : ""} /> 
                                    {isAiLoading ? "Menganalisa..." : "Auto-Isi dengan AI"}
                                </button>
                                <p className="text-xs text-center text-gray-400 mt-2">AI akan membaca & mengisi form di sebelah kanan otomatis.</p>
                            </div>
                        </div>

                        {/* RIGHT COLUMN: FORM INPUTS */}
                        <div className="lg:col-span-2 space-y-5">
                            {/* Section 1: Data Penyewa */}
                            <div className="bg-white p-5 rounded-2xl border border-gray-100 shadow-sm">
                                <h3 className="text-sm font-bold text-gray-400 uppercase tracking-wider mb-4 border-b pb-2">Informasi Penyewa</h3>
                                <div className="relative">
                                    <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-gray-400">
                                        <IconUser size={18} />
                                    </div>
                                    <input 
                                        type="text" 
                                        value={customerName} 
                                        onChange={(e)=>setCustomerName(e.target.value)} 
                                        className="pl-10 w-full p-3 rounded-xl border border-gray-200 focus:ring-2 focus:ring-indigo-500 transition-all font-medium text-gray-700"
                                        placeholder="Nama Pelanggan"
                                    />
                                </div>
                            </div>

                            {/* Section 2: Detail Unit & Layanan */}
                            <div className="bg-white p-5 rounded-2xl border border-gray-100 shadow-sm">
                                <h3 className="text-sm font-bold text-gray-400 uppercase tracking-wider mb-4 border-b pb-2">Detail Unit & Layanan</h3>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div className="relative">
                                        <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-gray-400">
                                            <IconGamepad size={18} />
                                        </div>
                                        <input 
                                            type="text" 
                                            value={psType} 
                                            onChange={(e)=>setPsType(e.target.value)} 
                                            className="pl-10 w-full p-3 rounded-xl border border-gray-200 focus:ring-2 focus:ring-indigo-500 transition-all text-sm"
                                            placeholder="Jenis Console (Ex: PS5)"
                                        />
                                    </div>
                                    <div className="relative">
                                        <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-gray-400">
                                            <IconClock size={18} />
                                        </div>
                                        <input 
                                            type="text" 
                                            value={duration} 
                                            onChange={(e)=>setDuration(e.target.value)} 
                                            className="pl-10 w-full p-3 rounded-xl border border-gray-200 focus:ring-2 focus:ring-indigo-500 transition-all text-sm"
                                            placeholder="Durasi (Ex: 24 Jam)"
                                        />
                                    </div>
                                    <div className="relative md:col-span-2">
                                        <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-gray-400">
                                            <IconMapPin size={18} />
                                        </div>
                                        <input 
                                            type="text" 
                                            value={delivery} 
                                            onChange={(e)=>setDelivery(e.target.value)} 
                                            className="pl-10 w-full p-3 rounded-xl border border-gray-200 focus:ring-2 focus:ring-indigo-500 transition-all text-sm"
                                            placeholder="Layanan Antar / Jemput"
                                        />
                                    </div>
                                </div>
                            </div>

                            {/* Section 3: Keuangan */}
                            <div className="bg-indigo-50 p-5 rounded-2xl border border-indigo-100 shadow-inner">
                                <h3 className="text-sm font-bold text-indigo-800 uppercase tracking-wider mb-4 flex items-center gap-2">
                                    <IconTag size={16}/> Rincian Biaya
                                </h3>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                    <div>
                                        <label className="text-xs font-semibold text-indigo-600 mb-1 block pl-1">Harga Sewa</label>
                                        <div className="relative">
                                            <span className="absolute inset-y-0 left-0 pl-3 flex items-center text-indigo-400 font-bold text-sm">Rp</span>
                                            <input 
                                                type="number" 
                                                value={price} 
                                                onChange={(e)=>setPrice(e.target.value)} 
                                                className="pl-10 w-full p-3 rounded-xl border border-indigo-200 focus:ring-2 focus:ring-indigo-500 font-bold text-gray-700"
                                                placeholder="0"
                                            />
                                        </div>
                                    </div>
                                    <div>
                                        <label className="text-xs font-semibold text-indigo-600 mb-1 block pl-1">Ongkos Kirim</label>
                                        <div className="relative">
                                            <span className="absolute inset-y-0 left-0 pl-3 flex items-center text-indigo-400 font-bold text-sm">Rp</span>
                                            <input 
                                                type="number" 
                                                value={shipping} 
                                                onChange={(e)=>setShipping(e.target.value)} 
                                                className="pl-10 w-full p-3 rounded-xl border border-indigo-200 focus:ring-2 focus:ring-indigo-500 font-bold text-gray-700"
                                                placeholder="0"
                                            />
                                        </div>
                                    </div>
                                </div>
                                <div className="flex justify-between items-center pt-4 border-t border-indigo-200">
                                    <span className="text-sm font-medium text-indigo-600">Total Tagihan</span>
                                    <span className="text-2xl font-extrabold text-indigo-700">Rp {currentTotal.toLocaleString('id-ID')}</span>
                                </div>
                            </div>

                            {/* Action Button */}
                            <button 
                                onClick={() => setShowInvoice(true)} 
                                className="w-full py-4 bg-gray-900 hover:bg-black text-white font-bold rounded-xl flex items-center justify-center gap-2 shadow-lg hover:shadow-xl transform hover:-translate-y-1 transition-all"
                            >
                                <IconPrinter size={20} /> 
                                Buat & Print Invoice
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- KOMPONEN 2: Isi Game ---
        const IsiGameForm = () => {
            const [customerName, setCustomerName] = useState('');
            const [consoleType, setConsoleType] = useState('');
            const [gameList, setGameList] = useState('');
            const [price, setPrice] = useState('');
            const [showInvoice, setShowInvoice] = useState(false);
            const [isPdfProcessing, setIsPdfProcessing] = useState(false);
            const invoiceRef = useRef();

            const handleDownloadPDF = async () => {
                if (!window.html2pdf) return;
                setIsPdfProcessing(true);
                const element = invoiceRef.current;
                const filename = `Invoice_IsiGame_${Date.now()}.pdf`;
                const opt = { margin: 0, filename: filename, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2, useCORS: true }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' } };
                try { window.html2pdf().set(opt).from(element).save(); } finally { setIsPdfProcessing(false); }
            };

            // Specific Terms for Isi Game
             const gameTerms = (
                <>
                    <p>1. Harap cek kembali daftar game yang diisi sebelum meninggalkan toko.</p>
                    <p>2. Garansi game (crash/macet) berlaku 3 hari setelah pengisian.</p>
                    <p>3. Tidak bertanggung jawab atas hilangnya save data jika terjadi error sistem.</p>
                </>
            );

            if(showInvoice) {
                return <InvoicePreview 
                    title="INVOICE ISI GAME"
                    customerName={customerName}
                    date={`Console: ${consoleType}`}
                    items={[{ name: "Jasa Isi Game", desc: `Daftar Game:\n${gameList}`, price: parseInt(price) || 0 }]}
                    total={parseInt(price) || 0}
                    terms={gameTerms}
                    onClose={() => setShowInvoice(false)}
                    onDownloadPDF={handleDownloadPDF}
                    isPdfProcessing={isPdfProcessing}
                    invoiceRef={invoiceRef}
                />;
            }

            return (
                <div className="p-6 space-y-6 animate-fade-in">
                    <div><label className="text-xs font-semibold text-gray-600">Nama Pelanggan</label><input type="text" value={customerName} onChange={(e)=>setCustomerName(e.target.value)} className="w-full p-2 rounded border border-gray-300" /></div>
                    <div><label className="text-xs font-semibold text-gray-600">Tipe Console</label><input type="text" value={consoleType} onChange={(e)=>setConsoleType(e.target.value)} className="w-full p-2 rounded border border-gray-300" placeholder="Ex: PS3 CFW / PS4 HEN" /></div>
                    <div><label className="text-xs font-semibold text-gray-600">Daftar Game</label><textarea value={gameList} onChange={(e)=>setGameList(e.target.value)} className="w-full p-2 rounded border border-gray-300 h-24" placeholder="Masukkan list game..." /></div>
                    <div><label className="text-xs font-semibold text-gray-600">Total Harga (Rp)</label><input type="number" value={price} onChange={(e)=>setPrice(e.target.value)} className="w-full p-2 rounded border border-gray-300 font-bold" /></div>
                    <button onClick={() => setShowInvoice(true)} className="w-full py-3 bg-indigo-600 text-white font-bold rounded-xl flex items-center justify-center gap-2"><IconPrinter size={20} /> Buat Invoice</button>
                </div>
            );
        };

        // --- KOMPONEN 3: Service ---
        const ServiceForm = () => {
            const [customerName, setCustomerName] = useState('');
            const [device, setDevice] = useState('');
            const [issue, setIssue] = useState('');
            const [price, setPrice] = useState('');
            const [showInvoice, setShowInvoice] = useState(false);
            const [isPdfProcessing, setIsPdfProcessing] = useState(false);
            const invoiceRef = useRef();

            const handleDownloadPDF = async () => {
                if (!window.html2pdf) return;
                setIsPdfProcessing(true);
                const element = invoiceRef.current;
                const filename = `Invoice_Service_${Date.now()}.pdf`;
                const opt = { margin: 0, filename: filename, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2, useCORS: true }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' } };
                try { window.html2pdf().set(opt).from(element).save(); } finally { setIsPdfProcessing(false); }
            };

            // Specific Terms for Service
            const serviceTerms = (
                <>
                    <p>1. Garansi service berlaku 1 minggu untuk kerusakan yang sama.</p>
                    <p>2. Barang yang tidak diambil lebih dari 1 bulan bukan tanggung jawab kami.</p>
                    <p>3. Segel rusak/hilang = Garansi Hangus.</p>
                </>
            );

            if(showInvoice) {
                return <InvoicePreview 
                    title="INVOICE SERVICE"
                    customerName={customerName}
                    date={`Unit: ${device}`}
                    items={[{ name: "Jasa Perbaikan / Service", desc: `Keluhan/Perbaikan:\n${issue}`, price: parseInt(price) || 0 }]}
                    total={parseInt(price) || 0}
                    terms={serviceTerms}
                    onClose={() => setShowInvoice(false)}
                    onDownloadPDF={handleDownloadPDF}
                    isPdfProcessing={isPdfProcessing}
                    invoiceRef={invoiceRef}
                />;
            }

            return (
                <div className="p-6 space-y-6 animate-fade-in">
                    <div><label className="text-xs font-semibold text-gray-600">Nama Pelanggan</label><input type="text" value={customerName} onChange={(e)=>setCustomerName(e.target.value)} className="w-full p-2 rounded border border-gray-300" /></div>
                    <div><label className="text-xs font-semibold text-gray-600">Unit / Device</label><input type="text" value={device} onChange={(e)=>setDevice(e.target.value)} className="w-full p-2 rounded border border-gray-300" placeholder="Ex: Stik PS4 / Mesin PS3" /></div>
                    <div><label className="text-xs font-semibold text-gray-600">Kerusakan / Tindakan</label><textarea value={issue} onChange={(e)=>setIssue(e.target.value)} className="w-full p-2 rounded border border-gray-300 h-24" placeholder="Deskripsi perbaikan..." /></div>
                    <div><label className="text-xs font-semibold text-gray-600">Biaya Service (Rp)</label><input type="number" value={price} onChange={(e)=>setPrice(e.target.value)} className="w-full p-2 rounded border border-gray-300 font-bold" /></div>
                    <button onClick={() => setShowInvoice(true)} className="w-full py-3 bg-indigo-600 text-white font-bold rounded-xl flex items-center justify-center gap-2"><IconPrinter size={20} /> Buat Invoice</button>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>